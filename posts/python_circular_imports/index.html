<!doctype html><html lang=en><head><title>Python got me with circular imports! :: Dhruv Patel</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Yet another way circular import can get you. This blog describes how Python import works, why circular imports cause issue and how to fix it."><meta name=keywords content="python circular imports"><meta name=robots content="noodp"><link rel=canonical href=https://dhruvpatel.dev/posts/python_circular_imports/><link rel=stylesheet href=https://dhruvpatel.dev/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://dhruvpatel.dev/css/code.min.4f0ccc8439f99bf7f7970298556b94011aabc1fcae743b6842fc3361a2da9ea3.css><link rel=stylesheet href=https://dhruvpatel.dev/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://dhruvpatel.dev/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://dhruvpatel.dev/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://dhruvpatel.dev/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://dhruvpatel.dev/css/main.min.15870410d15d02abd22fb5ef00996f65a00d04b3a7435e9f83831c7c2298de88.css><link rel=stylesheet href=https://dhruvpatel.dev/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://dhruvpatel.dev/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://dhruvpatel.dev/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://dhruvpatel.dev/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://dhruvpatel.dev/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://dhruvpatel.dev/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://dhruvpatel.dev/favicon.png><link rel=apple-touch-icon href=https://dhruvpatel.dev/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Python got me with circular imports!"><meta property="og:description" content="Yet another way circular import can get you. This blog describes how Python import works, why circular imports cause issue and how to fix it."><meta property="og:url" content="https://dhruvpatel.dev/posts/python_circular_imports/"><meta property="og:site_name" content="Dhruv Patel"><meta property="og:image" content="https://dhruvpatel.dev/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2021-04-14 21:51:48 +0530 +0530"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Dhruv Patel</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/about/>About</a></li><li><a href=https://github.com/DhruvPatel01/>Github</a></li><li><a href=/notes>Notes</a></li><li><a href=/now>Now</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about/>About</a></li><li><a href=https://github.com/DhruvPatel01/>Github</a></li><li><a href=/notes>Notes</a></li><li><a href=/now>Now</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://dhruvpatel.dev/posts/python_circular_imports/>Python got me with circular imports!</a></h1><div class=post-meta><time class=post-date>2021-04-14</time></div><span class=post-tags>#<a href=https://dhruvpatel.dev/tags/python-gotcha/>python-gotcha</a>&nbsp;
#<a href=https://dhruvpatel.dev/tags/python/>python</a>&nbsp;</span><div class=post-content><div><p>I have been programming in Python from last seven years. Apart from the new features Python adds in every new release, I didn&rsquo;t think Python would surprise me, until it did.</p><p>I will demonstrate what happened with the trimmed down code. I have two files, <code>main.py</code> and <code>notmain.py</code>. <code>main.py</code> has a global variable called <code>var</code>. <code>notmain</code> has some code that would process user input and add entry into <code>main.var</code>. Pretty simple, right?</p><details class=collapsable-code><summary title="Click to interact"><span class=collapsable-code__title>main.py</span></summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> notmain
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>var <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>work</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Before:&#34;</span>, var)
</span></span><span style=display:flex><span>    notmain<span style=color:#f92672>.</span>populate()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;After: &#34;</span>, var)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    work()</span></span></code></pre></div></details><details class=collapsable-code><summary title="Click to interact"><span class=collapsable-code__title>notmain.py</span></summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>populate</span>():
</span></span><span style=display:flex><span>    main<span style=color:#f92672>.</span>var[<span style=color:#e6db74>&#39;answer&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>42</span></span></span></code></pre></div></details><p>What do you think will happen when I run <code>python main.py</code>? Don&rsquo;t know about you, but I imagined that after I call <code>notmain.populate</code>, <code>main.var</code> will have one key, value in it.</p><pre tabindex=0><code>Shell&gt; python main.py
Before: {}
After:  {}
</code></pre><p>But boy I was wrong. To explain what just happened, let me try to explain how Python imports work.</p><h2 id=how-does-python-import-work-a-simple-version>How does Python import work? (A simple version)<a href=#how-does-python-import-work-a-simple-version class=hanchor arialabel=Anchor>#</a></h2><p>In what follows, I only explain what happens when you use <code>import x</code>. <code>from x import y</code> is not explained here.</p><p>When you import a module, two steps happen.</p><ol><li>Search (done by finder)</li><li>Load (done by loader)</li></ol><p>In the search step, <code>sys.modules</code> is the first place checked. If the module is not in <code>sys.modules</code>, Python will search for that module in other ways, current directory being one of them. Once the module(which was not in <code>sys.modules</code>) is found, it will be added to <code>sys.modules</code> before step 2 is executed. Thus if <code>a</code> imports <code>b</code>, and <code>b</code> imports <code>c</code>, and <code>c</code> imports <code>b</code>, <code>b</code> will not be executed again.</p><p>If the module was not found in <code>sys.modules</code>, the loading step will execute the module and the exported variables will be made available in the importee module.</p><p>One thing you should note is that everything in Python is an object. Even the imported module is. Try this,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> math<span style=color:#f92672>,</span> types
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> isinstance(math, types<span style=color:#f92672>.</span>ModuleType)
</span></span></code></pre></div><p>Objects are stored somewhere in memory. Try this,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(hex(id(math)))
</span></span><span style=display:flex><span><span style=color:#75715e># printed &#39;0x7f7e21029c20&#39; on my machine</span>
</span></span></code></pre></div><p>So everything in the object module will be available as attributes.</p><p>Now that we know how import works, let&rsquo;s try to see what happened with my code.</p><h2 id=what-happened-with-my-code>What happened with my code?<a href=#what-happened-with-my-code class=hanchor arialabel=Anchor>#</a></h2><p>Let&rsquo;s augment the files to print location of <code>var</code> object. That shall give some ideas.</p><details class=collapsable-code><summary title="Click to interact"><span class=collapsable-code__title>main.py</span></summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> notmain
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>var <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;In Main: &#34;</span>, hex(id(var)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>work</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Before:&#34;</span>, var, <span style=color:#e6db74>&#39;at&#39;</span>, hex(id(var)))
</span></span><span style=display:flex><span>    notmain<span style=color:#f92672>.</span>populate()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;After: &#34;</span>, var, <span style=color:#e6db74>&#39;at&#39;</span>, hex(id(var)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    work()</span></span></code></pre></div></details><details class=collapsable-code><summary title="Click to interact"><span class=collapsable-code__title>notmain.py</span></summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>populate</span>():
</span></span><span style=display:flex><span>    main<span style=color:#f92672>.</span>var[<span style=color:#e6db74>&#39;answer&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>42</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;In not main: &#39;</span>, main<span style=color:#f92672>.</span>var, <span style=color:#e6db74>&#39;at&#39;</span>, hex(id(main<span style=color:#f92672>.</span>var)))</span></span></code></pre></div></details><pre tabindex=0><code>Shell&gt; python main.py
In Main:  0x7f64e4778cc0
In Main:  0x7f64e490c6c0
Before: {} at 0x7f64e490c6c0
In not main:  {&#39;answer&#39;: 42} at 0x7f64e4778cc0
After:  {} at 0x7f64e490c6c0
</code></pre><p>First of all notice that <code>In Main: ...</code> line is printed two times. In the previous section I did tell that <strong>if the module is found in <code>sys.modules</code></strong>, the module will not be executed again. The problem is that <code>main.py</code> is only imported once, but executed twice.</p><p>Here is what happens.</p><ul><li><code>python main.py</code> starts executing.</li><li>The first line is <code>import notmain</code>. Since <code>notmain</code> is not in <code>sys.modules</code> yet, it will be executed next. Notice that <code>main</code> was never imported. So <code>sys.modules</code> does not have an entry for <code>main</code>.</li><li>Control goes to <code>notmain.py</code>. First line of it is <code>import main</code>, and as <code>main</code> is not in the cache, finder adds it into <code>sys.modules</code> and then loader starts executing <code>main.py</code> (again!).</li><li>Control goes to <code>main.py</code>. Since the first line is <code>import notmain</code> and <code>notmain</code> <strong>is in</strong> the <code>sys.modules</code> now, there is no effect.</li><li>Next line in <code>main.py</code> creates a variable <code>var@0x7f64e4778cc0</code>.</li><li>Next few lines defines a function <code>work</code>.</li><li>The <code>__name__ == '__main__'</code> condition is false, as at the moment <code>__name__ == 'main'</code></li><li>Control goes back to <code>notmain.py</code>. Attributes from the <code>main</code> module will now be accessible.</li><li><code>populate</code> is defined in <code>notmain</code>.</li><li>Control comes back to <code>main</code>.</li><li>Variable <code>var</code> is created (again!) and stored at <code>0x7f64e490c6c0</code>. Notice that there are two <code>var</code> variables. <code>notmain</code> has no idea that there is another <code>var</code> at <code>0x7f64e490c6c0</code>, it still thinks that <code>main.var</code> is at <code>0x7f64e4778cc0</code>.</li><li><code>work</code> function is defined.</li><li><code>__name__ == '__main__'</code> condition evaluates to true this time. So <code>work</code> is called, which calls <code>notmain.populate</code>.</li><li><code>notmain.populate</code> adds <code>answer</code> key into <code>main.var</code> and not <code>__main__.var</code>.</li></ul><p>The issue is self-evident now. We need to distinguish between <code>main</code> and <code>__main__</code>. A simple solution is to create another file that imports <code>main</code> and then calls <code>main.work</code>. This way when <code>notmain</code> calls import, <code>sys.modules</code> will already have an entry for <code>main</code> and <code>main</code> will not be executed again, and both <code>main</code> and <code>notmain</code> have same view of <code>var</code>. So let&rsquo;s try this.</p><details class=collapsable-code><summary title="Click to interact"><span class=collapsable-code__title>really_main.py</span></summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>.</span>work()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># no change in other files</span></span></span></code></pre></div></details><pre tabindex=0><code>Shell&gt; python really_main.py
Before:  {}
After:   {&#39;answer&#39;: 42}
</code></pre><p>Whooo! That worked.</p><h2 id=comments>Comments?<a href=#comments class=hanchor arialabel=Anchor>#</a></h2><p>You have any doubts? Any feedbacks? Please reach out to me at <code>hello at domain</code> with subject line <code>Comment: Post title</code>. I&rsquo;ll get back to you as soon as possible.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://dhruvpatel.dev/posts/why_blelloch_scan_works/ class="button inline prev">&lt; [<span class=button__text>Why Blelloch Scan Works</span>]
</a>::
<a href=https://dhruvpatel.dev/posts/notaerocalc/notaerocalc_part1/ class="button inline next">[<span class=button__text>NotAeroCalc Part 1: What is NotAeroCalc and how to use it?</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Dhruv Patel</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>